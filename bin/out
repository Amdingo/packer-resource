#!/bin/sh
set -eu -o pipefail
exec 3>&1 1>&2

jq . < /dev/stdin > /tmp/input

SRC=$1

TEMPLATE=$(jq -r '.params.template // empty' /tmp/input)
if [ -z "$TEMPLATE" ]; then
  echo "template not passed in params:" >&2
  jq '.params // {}' /tmp/input >&2
  exit 1
fi

jq '.params|del(.template) // empty' /tmp/input > /tmp/var.json

# FIXME: check for var_file parameter, put before params-derived -var-file
# so they override like -var parameters

packer build -machine-readable -var-file=/tmp/var.json $SRC/$TEMPLATE \
  | tee /tmp/output \
  | awk -F, '/,(say|message),/ { print $5 }'

# FIXME: include metadata such as AMI name, copied region: ami-id, etc.
# ... um, but generalise it for other kinds of packer builders, yeah?

AMI=$(awk -F: '/artifact,0,id/ { print $2 }' /tmp/output)

echo '{ "version": { "ami": "'$AMI'" } }' >&3
